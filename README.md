#Plants VS Zombies Report for Developer
-----
##1 工程简介
该程序由Qt开发，库为Qt 5.7.0，默认编译器为mingw32 GNU Make 4.1版本。

其中，源文件和工程文件均位于工程根目录下，其中Plants-VS-Zombies.pro为该工程的工程文件。音乐文件位于 ./res/audio目录下，图片文件位于./res/images目录下。
##2 类设计
该程序的类设计主要分为窗体类，植物类，僵尸类和其他类。
###2.1 窗体类
窗体类主要负责程序各阶段对应窗体的UI设计与对应的业务逻辑。其均继承自一个基类`AbstractWidget`。该类继承自`QWidget`,仅提供一个信号`void StatusChanged(GameStatus)`，用于表示该窗口将要被销毁切换。该类有四个子类，`WelcomeWidget`、`AdvenceWidget`、`WinWidget`、`FailWidget`分别对应开始界面、正常游戏界面、胜利界面和死亡界面。
###2.2 植物类
植物类主要负责植物各项数据的存储和相应的处理函数。植物类均继承自基类`AbstractPlant`，该类继承自基类`QObject`，该类提供了植物的属性变量和相关操作函数。该类有三个子类`SunFlower`、`Peashooter`、`WallNut`，分别对应向日葵、豌豆射手、坚果墙。
###2.3 僵尸类
僵尸类主要负责僵尸各项数据的存储和相应的处理函数。僵尸类均继承自基类`AbstractZombie`，该类继承自基类`QObject`，该类提供了僵尸的属性变脸和相关操作函数。该类有三个子类`NormalZombie`、`BucketheadZombie`、`PoleVaultingZombie`，分别对应普通僵尸、铁桶僵尸、撑杆跳僵尸。
###2.4 其他类
其他类具体列表如下：    

- `Pea`：豌豆类，封装了豌豆的图像表示和移动销毁的函数与信号  
- `Sun`：阳光类，封装了阳光的图像表示、阳光下落回收等动画的响应函数和计时器。其中，阳光图绘制在一个自定义窗口部件`Label`中，该部件继承自`QLabel`，新增了一个`clicked()`信号及重写了`void mousePressEvent(QMouseEvent*)`函数，使得其可以响应点击事件并发出信号。  
- `PlantCard`：卡片类，封装了不同卡片的图像表示和卡片冷却、点亮等动画的操作函数。   
- `CardManager`、`SunManager`、`WarManager`：管理器类。其中卡片管理类用于分配卡片、提供卡片索引，并在阳光值变化时、种植植物后刷新卡片状态；阳光管理器类负责处理阳光的产生和销毁，阳光数目的增加、减少以及打印；战争管理器负责全局规划，储存植物、豌豆和僵尸状态，并进行战斗判定和刷新。

##3 程序架构和功能实现
该程序包含一个全局变量管理器，里面包含用于标记全局状态的若干变量，并在程序的`main`函数中，调用函数`void initGlobalManager()`来进行设备相关变量的初始化。

该程序提供了不同屏幕分辨率的适配处理。其具体实现为，在`initGlobalManager()`函数中，获取屏幕的相关分辨率，然后根据长宽比与1280*800进行比较，获得一个比例参数，并在每次图像处理中将图像的长宽均与该参数相乘，从而使得该程序可以再不同屏幕上获得大致相同的结果。

该程序主窗口仅为一个不包含任何窗体控件的继承自`QMainWindow`的类。在该类中保存了一个`AbstractWidget`类型的指针，用于指向当前的游戏窗体，并通过槽函数`void SwitchStatus(GameStatus)`与`AbstractWidget`指针的`StatusChanged(GameStatus)`信号关联，来切换窗口状态。

游戏开始界面通过设定鼠标追踪、设置事件检视器和重写消息处理函数来实现对于鼠标移动、点击和释放等操作中光标的转化、图片的加载和事件的处理。在这里该程序所做的稍微细致，可以实现对于鼠标拖动等不同操作下消息的合理响应。（限于篇幅和目的暂不展开）

在游戏战斗主窗口中，通过两套机制来完成功能的实现。首先是信号与槽机制。例如，植物生产阳光和发射豌豆均为发射包含对应信息的信号，然后通过`WarManager`类中定义的连接，发射信号给`SunManager`类和`WarManager`类的对应槽函数加以处理。另外一套机制为计时器定时刷新机制，在`WarManager`类中包含一个间隔时间为10毫秒的计时器和对应的响应函数，该函数负责处理僵尸的定时生产、豌豆和僵尸的移动、豌豆打击僵尸的判定、僵尸吃植物的判定、僵尸和植物的死亡判定、植物发现僵尸发射豌豆僵尸死亡停止发射的判定等。此处大于10毫秒的难以保证响应效率，设定为5毫秒则会使程序出现明显变慢。
##4 作者信息
Author： 清华大学软件学院 苑昊  
Date：2016/9/11  
Email: yuanhaoreginald@gmail.com